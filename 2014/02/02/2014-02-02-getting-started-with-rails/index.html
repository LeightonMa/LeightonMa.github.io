<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Getting Started with Rails | Karmapo&#39;s Place</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="og:type" content="blog">
<meta name="og:title" content="Getting Started with Rails">
<meta name="og:url" content="http://leightonma.github.io/2014/02/02/2014-02-02-getting-started-with-rails/">
<meta name="og:image">
<meta name="og:site_name" content="Karmapo's Place">
<meta name="og:description" content="总揽：

如何安装 Rails，创建一个新的 Rails App，将 app 与数据库对接。
The general layout of a Rails application
MVC 的基本原则以及 RESTful 设计理念
如何迅速生成 Rails application 的初始代码块




Guide Assumptions

为了运行 ROR 4.0.2 需要预装以下内容:

Ruby">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Karmapo&#39;s Place" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="http://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Karmapo&#39;s Place</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">AboutMe</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://leightonma.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2014-02-02-getting-started-with-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/02/02/2014-02-02-getting-started-with-rails/" class="article-date">
  <time datetime="2014-02-02T14:49:42.000Z" itemprop="datePublished">2月 2 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/RailsGuides/">RailsGuides</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Getting Started with Rails
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>总揽：</p>
<ol>
<li>如何安装 Rails，创建一个新的 Rails App，将 app 与数据库对接。</li>
<li>The general layout of a Rails application</li>
<li>MVC 的基本原则以及 RESTful 设计理念</li>
<li>如何迅速生成 Rails application 的初始代码块</li>
</ol>
<a id="more"></a>


<h2 id="guide-assumptions">Guide Assumptions</h2>
<hr>
<p>为了运行 ROR 4.0.2 需要预装以下内容:</p>
<ul>
<li>Ruby 1.9.3 及以上版本。</li>
<li>The RubyGems packaging system</li>
<li>SQLite3 Database</li>
</ul>
<p>与此同时，你需要有必要的 Ruby 语言知识。（注：译者建议使用 Learn Ruby The Hard Way 进行入门）</p>
<h2 id="rails-">Rails 是什么？</h2>
<hr>
<p>Rails 是一个迅速搭建 web application 的框架。由 Ruby 写成。可以大大提升开发者的开发效率。</p>
<p>Rails 理念包含两方面：</p>
<ul>
<li>DRY－Don’t Repeat Yourself 去除代码冗余。</li>
<li>Convention Over Configuration－意味着，Rails 会默认假设你要做什么和如何做，而并不是要求你一开始就陷入无止尽的配置文件中。</li>
</ul>
<h2 id="-rails-project">创建一个新的 Rails Project</h2>
<hr>
<h4 id="-rails">安装 Rails</h4>
<p>检测 ruby 版本，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>ruby <span class="attribute">-v</span>
</pre></td></tr></table></figure>

<p>安装 rails，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>gem <span class="keyword">install</span> rails
</pre></td></tr></table></figure>

<p>安装完毕后检测 Rails 是否正常安装，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>rails —<span class="built_in">version</span>
</pre></td></tr></table></figure>

<p>返回是 &gt;~4.0.0 表示正常进入下一个环节。</p>
<h4 id="-blog-application">创建一个 Blog Application</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>rails <span class="keyword">new</span> blog
</pre></td></tr></table></figure>

<p>这样就可以创建出一个在 blog 目录下的叫做 Blog 的 Rails application，同时会默认执行 bundle install 安装 Gemfile 中的 Gem dependencies。</p>
<p>创建后，进入项目目录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="built_in">cd</span> blog
</pre></td></tr></table></figure>

<p>在这个生成的目录内的文件，在这个教程中我们的操作主要集中在 app/ 文件夹下。</p>
<p>下面的基础纲要会简单解释一下 blog 目录下默认创建的每个文件和文件夹的作用</p>
<table>
<thead>
<tr>
<th>File/Folder</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>app/</td>
<td>包含了应用中的 MVC 三层，以及 helpers、mailers、assets</td>
</tr>
<tr>
<td>bin/</td>
<td>包含了用来启动 app，以及部署、运行 app 的 rails 脚本文件</td>
</tr>
<tr>
<td>config/</td>
<td>配置应用的运行时规则，路径，数据库等内容，</td>
</tr>
<tr>
<td>config.ru</td>
<td>基于 rack[^1] 服务端用来启动 application 的 rack 配置文件 </td>
</tr>
<tr>
<td>db/</td>
<td>包含了现在数据库 schema 以及数据库的 migrations 文件</td>
</tr>
<tr>
<td>Gemfile(.lock)</td>
<td>在这里决定应用需要哪些 Gem(Bundler gem)</td>
</tr>
<tr>
<td>lib/</td>
<td>存放应用的扩展模块</td>
</tr>
<tr>
<td>log/</td>
<td>应用的日志文件</td>
</tr>
<tr>
<td>public/</td>
<td>唯一可以被外界查看的文件夹，存放静态文件和被编译后的 assets</td>
</tr>
<tr>
<td>rakefile</td>
<td>这个文件用来定位和加载通过命令行运行的 tasks，如果要添加自己的任务需要将文件放入 lib/tasks 目录下</td>
</tr>
<tr>
<td>README.rdoc</td>
<td>针对这个 app 的简要使用手册，通过这个文件告诉其他人这个 app 是用来做什么的。可以改成 md 格式。</td>
</tr>
<tr>
<td>test/</td>
<td>包含单元测试，fixtures 以及其他测试组件</td>
</tr>
<tr>
<td>tmp/</td>
<td>临时文件 cache, pid, session files</td>
</tr>
<tr>
<td>vendor/</td>
<td>存放所有第三方代码</td>
</tr>
</tbody>
</table>
<h2 id="hello-rails">Hello, Rails</h2>
<hr>
<h4 id="-web-">开始运行 Web 服务</h4>
<p>进入 application 的根目录执行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>rails <span class="keyword">server</span>
</pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>注意：将 CoffeeScript 编译成 JavaScript 需要一个 JS runtime，如果缺失这个组件就会得到一个 execjs 报错。通常 OS X 和 Windows 都会默认有这个组件，但是如果存在问题或是需要的话，可以使用 Gemfile 被注释的 therubyracer gem。这个组件是在 JRuby 环境下的推荐配置。
</pre></td></tr></table></figure>

<p>这会启动 WEBrick，Ruby 内置的默认 web 服务，此时进入 localhost:3000 即可看到 Rails 的默认信息页。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>注意：通过<span class="keyword">control</span>+c 关闭这个服务。在开发模式下，当你修改了代码，rails 可以自动将变化带入到站点中，不需要进行重启服务。
</pre></td></tr></table></figure>

<h4 id="say-hello-rails">Say &quot;Hello&quot;, Rails</h4>
<p>在这里为了建立一个最简单的页面，需要分别建立一个 Controller 和 View。</p>
<p>控制器的目的是为了从 application 中接受特定的指令。<em>Routing</em>决定了哪个控制器接收哪个请求。通常，某个控制器都可能有多个 route，不同的路径会被匹配不同的 actions。每个 action 的任务是获取信息将其提供给视图层。</p>
<p>视图的目的是用人类能够理解的方式展示信息。需要注意的是，收集信息是由控制层完成的，视图仅仅是展示这些信息。默认情况下，视图模版是用 ERB(Embedded Ruby 写成的)。</p>
<p>为了建立一个新的控制器，需要运行控制器生成器，需要让控制器叫做 welcome，同时在其中有一个 action 叫做 index</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>rails generate controller welcome <span class="keyword">index</span>
</pre></td></tr></table></figure>

<p>Rails 会自动创建一系列文件和一个路径。</p>
<p>在这些文件中最重要的文件，控制器位于 app/controllers/welcome_controller.rb; 视图位于 app/views/welcome/index.html.erb</p>
<p>打开视图文件，删除里面代码，写入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Hello, Rails<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
</pre></td></tr></table></figure>

<h4 id="-">设置应用的首页</h4>
<p>在创建好控制器和视图后，我们希望这个页面成为应用的首页，已进入 localhost:3000 就可以得到这个页面。</p>
<p>进入 config/routes.rb，可以看到语句<code>get &quot;welcome/index&quot;</code>。</p>
<p>这是应用的路径文件。这个文件是由特殊的 DSL(domain-specific language) 写成的。告诉 Rails 如何将获得的请求和控制器、Action 联系起来。在这里，首页的配置可以这样完成。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>root <span class="string">"welcome#index"</span>
</pre></td></tr></table></figure>

<p>默认的路径指向<a href="http://localhost:3000/welcome/index">http://localhost:3000/welcome/index</a>。后者路径将指向<a href="http://localhost:3000/">http://localhost:3000/</a></p>
<h2 id="getting-up-and-running">Getting Up and Running</h2>
<hr>
<p>在应用中，你将要创建一个新的<strong>resource</strong>。</p>
<p>A <strong>resource</strong> is the term used for a collection of similar objects. </p>
<p>resource 是一组简单对象的集合。可以对一个 resource 进行增删改查 CRUD 操作。</p>
<p>Rails 提供了一个 resources 方法。这个方法是用来声明 REST resource。Here&#39;s how config/routes.rb will look like.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre>Blog::Application.routes.draw <span class="built_in">do</span>
  
<span class="number">2</span>resources :posts

<span class="number">2</span>root <span class="built_in">to</span>: <span class="string">"welocome#index"</span>
<span class="function"><span class="keyword">end</span></span>
</pre></td></tr></table></figure>

<p>如果此时 rake routes。就可以得到一套标准 RESTful actions。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>rake routes
(<span class="operator">in</span> /Users/maleighton/rails_projects/blog)
    Prefix Verb   URI Pattern              Controller<span class="comment">#Action</span>
post_index GET    /<span class="built_in">post</span>(.:<span class="built_in">format</span>)          <span class="built_in">post</span><span class="comment">#index</span>
           POST   /<span class="built_in">post</span>(.:<span class="built_in">format</span>)          <span class="built_in">post</span><span class="comment">#create</span>
  new_post GET    /<span class="built_in">post</span>/<span class="built_in">new</span>(.:<span class="built_in">format</span>)      <span class="built_in">post</span><span class="comment">#new</span>
 edit_post GET    /<span class="built_in">post</span>/:id/edit(.:<span class="built_in">format</span>) <span class="built_in">post</span><span class="comment">#edit</span>
      <span class="built_in">post</span> GET    /<span class="built_in">post</span>/:id(.:<span class="built_in">format</span>)      <span class="built_in">post</span><span class="comment">#show</span>
           PATCH  /<span class="built_in">post</span>/:id(.:<span class="built_in">format</span>)      <span class="built_in">post</span><span class="comment">#update</span>
           PUT    /<span class="built_in">post</span>/:id(.:<span class="built_in">format</span>)      <span class="built_in">post</span><span class="comment">#update</span>
           DELETE /<span class="built_in">post</span>/:id(.:<span class="built_in">format</span>)      <span class="built_in">post</span><span class="comment">#destroy</span>
      root GET    /                        welcome<span class="comment">#index</span>
</pre></td></tr></table></figure>

<p>在下一部分，将会添加两个功能，一个是在应用中创建新的 posts，另一个是查看它们。</p>
<h4 id="laying-down-the-ground-work">Laying down the ground work</h4>
<p>首先要在应用中实现 create 操作。/posts/new。在前面 rake routes 中已经生成了这个路径，但是此时进入改路径会得到一个 routing error.</p>
<p>发生错误的原因是，这个路径需要一个对应的控制器来接收并完成这个请求。解决的方案就是建立一个叫做 PostsContrller 的控制器。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>rails g controller posts
</pre></td></tr></table></figure>

<p>此时进入新生成的文件 app/controllers/posts_controller.rb，你可以看到一个空的控制器</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">PostsController</span> <span class="inheritance">&lt; <span class="parent">ApplicationController</span></span></span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>控制器是继承于 ApplicationController 的一个类。在其中定义的方法就会成为控制器的 actions。Actions 将会完成针对 posts 的 CRUD 操作。</p>
<p><em>注意</em>：Ruby 类中包含 public、private、protected 三类方法，actions 只能是 public 方法。</p>
<p>刷新<a href="http://localhost:3000/posts/new">http://localhost:3000/posts/new</a>. 得到新错误，方法不存在。</p>
<p>我们在对应的控制器中添加方法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>def <span class="built_in">new</span>
<span class="function"><span class="keyword">end</span></span>
</pre></td></tr></table></figure>

<p>再次刷新页面，得到错误<em>找不到模版</em></p>
<blockquote>
<p>Missing template posts/new, application/new with {:locale=&gt;[:en], :formats=&gt;[:html], :handlers=&gt;[:erb, :builder, :raw, :ruby, :jbuilder, :coffee]}. Searched in: * &quot;/Users/maleighton/rails_projects/blog/app/views&quot;</p>
</blockquote>
<p>第一部分表明了哪一部分的模版缺失了。在这里是 posts/new 模版。Rails 会首先查找这个模版，如果找不到，他会尝试载入一个叫做 application/new 的模版。原因在于 PostsController 是继承于 ApplicationController。</p>
<p>第二部分是一个散列表。:locale 键表明模版会得到的语言。默认情况下是 en，英语。:formats 表明模版响应服务的格式。默认是:html 格式，所以 Rails 会寻找一个 HTML 模版。:handlers 表明模版的处理方式，:erb 是最常见用于 HTML 模版的方式，:builder 用于 XML 模版，:coffee 用于 JS 模版。</p>
<p>最后一部分，告知我们 Rails 在哪里寻找模版。基础的 Rails 应用会将模版放在一个地方，复杂的应用可以将模版放在许多不同的路径下。</p>
<p>在这里，模版放于 app/views/posts/new.html.erb。第一个扩展名 html 表明了模版的 format 格式，第二个扩展名表明使用的 handler。Rails 会尝试在 app/views/posts/new 寻找这个模版。格式必须是 html，handlers 可以是 6 种形式。</p>
<p>新建 app/views/posts/new.html.erb 写入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h1</span>&gt;</span>New Post<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
</pre></td></tr></table></figure>

<p>刷新页面，代码正常工作</p>
<h4 id="the-first-form">The first form</h4>
<p>为了在模版内创建一个表哥，需要使用一个 form builder, 最主要的 form builder 叫做 form_for，是由一个 helper method 提供。写入 app/views/posts/new.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="vbscript">&lt;%= form_for :post <span class="keyword">do</span> |f| %&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :title %&gt;</span><span class="tag">&lt;<span class="title">br</span>&gt;</span>
22<span class="vbscript">&lt;%= f.text_field :title %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :text %&gt;</span><span class="tag">&lt;<span class="title">br</span>&gt;</span>
22<span class="vbscript">&lt;%= f.text_area :text %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.submit %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
</pre></td></tr></table></figure>

<p>当你调用 form_for，传递一个 identifying object 给这个表格。在这里，传递的是 symbol :post。 这告诉 form_for helper 这个表格的为了什么对象而做的。在代码块离，这个 FormBuilder 对象由 f 代表，用来建立两个 labels 和两个文本域。一个是 title，一个是 text，最后调用 submit 给表格建立一个提交按钮。</p>
<p>这里存在一个问题。如果此时通过源代码检测生成的 HTML，你会发现表格 action 的值指向的是 /posts/new。这个页面本该是用来展示 new post 的表格的，不应该是信息提交的页面。</p>
<p>为了让它去到别的地方，表格需要使用一个不同的 URL。通过 form_for 种的:url 选项。一般在 rails 中，用来进行 new form 提交的 action 叫做“create”，所以表格需要指向这个 action。</p>
<p>编辑 form_for</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>&lt;<span class="variable">%=</span> form_for :post, url: posts_path <span class="keyword">do</span> |f| <span class="variable">%&gt;</span>
</pre></td></tr></table></figure>

<p>在这个例子中，<strong>the posts_path helper</strong>传递给了:url option。<strong>Rails 将会将表格信息指向当前控制器的 create action。</strong>同时传递一个 POST 请求到那个路径。</p>
<p>刷新页面，提交之后，会报错，无法找到 create 方法。</p>
<h4 id="creating-posts">Creating posts</h4>
<p>在 PostsController 类中创建这个 Action</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">PostsController</span> <span class="inheritance">&lt; <span class="parent">ApplicationController</span></span></span>
<span class="number">2</span>def new
<span class="number">2</span><span class="keyword">end</span>

<span class="number">2</span>def create
<span class="number">2</span><span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>在这里进行提交，会出现<em>模版不存在</em>的错误。我们先忽略这个错误。The create action 需要将我们新的 post 存放到数据库里。</p>
<p>当表格提交之后，表格内的域会作为参数发送给 Rails。这些参数可以在控制器的 action 中进行调用，从而来执行特定的任务。为了看到这些参数，我们将 create action 改变为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>def <span class="built_in">create</span>
<span class="number">2</span>render <span class="keyword">text</span>: <span class="built_in">params</span>[:<span class="built_in">post</span>].inspect
<span class="function"><span class="keyword">end</span></span>
</pre></td></tr></table></figure>

<p>在这里的 render 方法里包含了一个简单的散列表，包含一个 text 键，和一个 params[:post].inspect 值。params 方法是从表格中获取参数的对象。params 方法返回一个 ActiveSupport::HashWithIndifferentAccess 对象，允许你使用字符串或者 symbols 来取得散列表的键。</p>
<p>此时你再重复提交一次表格，就不会再得到错误，而是获得一个显示在页面上的散列表。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>{<span class="string">"title"</span>=&gt;<span class="string">"test"</span>, <span class="string">"text"</span>=&gt;<span class="string">"this is a test."</span>}
</pre></td></tr></table></figure>

<h4 id="creating-the-post-model">Creating the Post model</h4>
<p>Models 在 Rails 中使用的是<strong>单数</strong>，而和它们相关的数据库表单使用的是复数名称。Rails 提供了创建 models 的生成器。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>rails generate model Post title:<span class="keyword">string</span> <span class="keyword">text</span>:<span class="keyword">text</span>
</pre></td></tr></table></figure>

<p>在这里我们告诉 Rails，我们需要建立一个 Post model，包含一个 title 字段类型是 string，一个 text 字段类型是 text。执行后生成一系列的文件。我们现在主要对 models 下的 post.rb 和 migrate 下的 create_posts.rb 两个文件进行讲解。后者是用来创建数据库结构的。</p>
<p><em>注意</em>： Active Record 会自动帮你完成模型内字段的创建。</p>
<h4 id="running-a-migration">Running a Migration</h4>
<p>Migration 是用来创建并修改数据库表单的 Ruby 类。Rails 使用 rake 命令来运行 migrations，同时你可以对已经执行的 migrations 进行撤销。</p>
<p>打开 migration 文件，可以看到</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">CreatePosts</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Migration</span></span></span>
  <span class="function"><span class="keyword">def</span> </span>change
    create_table <span class="symbol">:posts</span> <span class="keyword">do</span> |t|
      t.string <span class="symbol">:title</span>
      t.text <span class="symbol">:text</span>

      t.timestamps
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>在这里创建里一个方法 change，当你运行 migration 的时候可以调用这个方法。在这里定义的这个方法也可以反向操作，即撤销这个方法对数据库的影响。当你执行后，就会在数据库中生成一个 posts 表。除去 title 和 text 两个字段之外，还存在一个时间戳，用来记录 post 创建和更新的时间。</p>
<p>运行 migration</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre>rake db:migrate
(in /Users/maleighton/rails<span class="emphasis">_projects/blog)
==  CreatePosts: migrating ====================================================
-- create_</span>table(:posts)
<span class="code">   -&gt; 0.0017s</span>
<span class="header">==  CreatePosts: migrated (0.0018s) ===========================================</span>
</pre></td></tr></table></figure>

<p><em>注意</em>：由于默认我们是在开发环境下进行开发，这个命令将会操作的是 config/database.yml 内的开发环境区块的数据库，如果需要将迁移作用到 production 环境下，需要执行<strong>rake db:migrate RAILS_ENV=production</strong></p>
<h4 id="saving-data-in-the-controller">Saving data in the controller</h4>
<p>数据库配置完成后，改变 the create action，将获取的数据存入到 Post model 中。进入 app/controllers/posts_controller.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>def <span class="built_in">create</span>
<span class="number">2</span>@<span class="built_in">post</span> = Post.<span class="built_in">new</span>(<span class="built_in">params</span>[:<span class="built_in">post</span>])
<span class="number">2</span>@<span class="built_in">post</span>.save
<span class="number">2</span>redirect_to @<span class="built_in">post</span>
<span class="function"><span class="keyword">end</span></span>
</pre></td></tr></table></figure>

<p>每个 Rails model 都可以初始化自己的每个字段。@post.save 负责将 model 存入到数据库内。最后我们重定向到<strong>show action</strong>。</p>
<p><em>注意</em>：@post.save 会返回一个布尔值，告知 model 是否保存成功。</p>
<p>此时提交表格会返回一个错误 ActiveModel::ForbiddenAttributesError</p>
<p>Rails 存在多个安全特性来帮助我们写出安全性更高的应用。现在在这里我们需要使用 strong_parameters, 需要我们明确告诉 Rails 需要接收哪几个参数。在这里我们需要接收 title 和 text 两个参数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre>def <span class="built_in">create</span>
<span class="number">2</span>@<span class="built_in">post</span> = Post.<span class="built_in">new</span>(post_params)
<span class="number">22</span>
<span class="number">2</span>@<span class="built_in">post</span>.save
<span class="number">2</span>redirect_to @<span class="built_in">post</span>
<span class="function"><span class="keyword">end</span></span>

<span class="keyword">private</span>
<span class="number">2</span>def post_params
<span class="number">22</span><span class="built_in">params</span>.<span class="built_in">require</span>(:<span class="built_in">post</span>).permit(:title, :<span class="keyword">text</span>)
<span class="number">2</span><span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>permit 允许我们在这个 action 中同时接收 title 和 text 两个参数。</p>
<p><em>注意</em>：def post_params 是 private，这个方式是为了防止攻击者通过操作传递给 model 的散列表来设置 model&#39;s 内的 attr</p>
<p>此时进行重复提交表单，得到的错误是缺失方法 show。</p>
<h4 id="showing-posts">Showing Posts</h4>
<p>接着开始添加 show action</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>post <span class="constant">GET</span>  /posts/<span class="symbol">:id</span>(.<span class="symbol">:format</span>)   posts<span class="comment">#show</span>
</pre></td></tr></table></figure>

<p>这里的:id 表示 rails 要接收一个:id 参数，在这里是我们 post 的 id。将方法写入控制器中。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="function"><span class="keyword">def</span> </span>show
<span class="number">2</span><span class="variable">@post</span> = <span class="constant">Post</span>.find(params[<span class="symbol">:id</span>])
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>在这里我们通过 model 方法 Post.find 方法找到我们需要的 post。同时使用一个实例化变量 @post 来获得 post 对象的 reference。这个变量会被传递到视图文件中。</p>
<p>建立新文件 app/views/posts/show.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">strong</span>&gt;</span>Title:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span>
2<span class="vbscript">&lt;%= @post.title %&gt;</span>
 <span class="tag">&lt;/<span class="title">p</span>&gt;</span>

 <span class="tag">&lt;<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">strong</span>&gt;</span>Text:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span>
2<span class="vbscript">&lt;%= @post.text %&gt;</span>
 <span class="tag">&lt;/<span class="title">p</span>&gt;</span>
</pre></td></tr></table></figure>

<p>重新提交表单，本次成功。</p>
<h4 id="listing-all-posts">Listing all posts</h4>
<p>我们需要一个方法来显示我们所有的 posts</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>posts <span class="constant">GET</span>  /posts(.<span class="symbol">:format</span>)  posts<span class="comment">#index</span>
</pre></td></tr></table></figure>

<p>在控制器中写入方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="function"><span class="keyword">def</span> </span>index
<span class="number">2</span><span class="variable">@posts</span> = <span class="constant">Post</span>.all
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>我们为它添加一个视图文件，app/views/posts/index.html.erb:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Listing posts<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>

 <span class="tag">&lt;<span class="title">table</span>&gt;</span>
2<span class="tag">&lt;<span class="title">tr</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span>Title<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span>Text<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
2<span class="tag">&lt;/<span class="title">tr</span>&gt;</span>

2<span class="vbscript">&lt;% @posts.<span class="keyword">each</span> <span class="keyword">do</span> |post| %&gt;</span>
22<span class="tag">&lt;<span class="title">tr</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= post.title %&gt;</span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= post.text %&gt;</span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
22<span class="tag">&lt;/<span class="title">tr</span>&gt;</span>
2<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
 <span class="tag">&lt;/<span class="title">table</span>&gt;</span>
</pre></td></tr></table></figure>

<h4 id="adding-links">Adding links</h4>
<p>现在已经可以 create、show、list posts，接着添加链接来进行页面的导航。</p>
<p>进入 app/views/welcome/index.html.erb 修改如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Listing posts<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
 <span class="vbscript">&lt;%= link_to <span class="string">"My Blog"</span>, controller: <span class="string">"posts"</span> %&gt;</span>
</pre></td></tr></table></figure>

<p><strong>link_to</strong>方法是 Rails 内置视图 helpers 之一，根据文字创建出超链接。这里的路径指向 /posts。</p>
<p>在其他视图页面添加链接，进入 app/views/posts/index.html.erb。将以下代码放置于<table>之上</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>&lt;<span class="variable">%=</span> link_to <span class="string">'New post'</span>, new_post_path <span class="variable">%&gt;</span>
</pre></td></tr></table></figure>

<p>同样，我们在新建 post 页面也建立链接，让其可以返回 index action, 放在表单后。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>&lt;<span class="variable">%=</span> link_to <span class="string">'Back'</span>, posts_path <span class="variable">%&gt;</span>
</pre></td></tr></table></figure>

<p>最后，在 show 页面添加返回 index 的链接。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>&lt;<span class="variable">%=</span> link_to <span class="string">'Back'</span>, posts_path <span class="variable">%&gt;</span>
</pre></td></tr></table></figure>

<p><em>注意</em>：如果链接指向的 action 是在同一个控制器内，不需要加上:controller 选项。</p>
<h4 id="allowing-the-update-of-fields">Allowing the update of fields</h4>
<p>在 model 文件里，打开 app/models/post.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>需要注意的是 Post 类是继承于 ActiveRecord::Base。AR 提供了许多功能给 models，包括基础的针对数据库的 CRUD 操作，数据验证，以及精确的搜索支持，多个 models 互相关联的功能。</p>
<h4 id="adding-some-validation">Adding Some Validation</h4>
<p>Rails 提供了许多方法来帮助你针对传递过来的数据进行验证。打开 app/models/post.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre><span class="tag">validates</span> <span class="pseudo">:title</span>, <span class="tag">presence</span>: <span class="tag">true</span>,
2222  <span class="tag">length</span>: <span class="rules">{<span class="rule"><span class="attribute">minimum</span>:<span class="value"> <span class="number">5</span></span></span></span>}
</pre></td></tr></table></figure>

<p>这里保证了每个 title 都必须由一个最短为 5 个字符的标题。validates 可以在 model 中验证一系列的条件。</p>
<p>当验证存在时，如果为不满足条件的 @post.save，就会返回 false，在现在的控制器中，我们没有考虑返回 false 的情况，我们需要将错误的信息返回给用户，于是我们改变 new 和 create actions。app/controllers/posts_controller.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre>def <span class="built_in">new</span>
<span class="number">2</span>@<span class="built_in">post</span> = Post.<span class="built_in">new</span>
<span class="function"><span class="keyword">end</span></span>

def <span class="built_in">create</span>
<span class="number">2</span>@<span class="built_in">post</span> = Post.<span class="built_in">new</span>(<span class="built_in">params</span>[:<span class="built_in">post</span>].permit(:title, :<span class="keyword">text</span>))
<span class="number">22</span>
<span class="number">2</span><span class="keyword">if</span> @<span class="built_in">post</span>.save
<span class="number">22</span>redirect_to @<span class="built_in">post</span>
<span class="number">2</span><span class="keyword">else</span>
<span class="number">22</span>render <span class="string">'new'</span>
<span class="number">2</span><span class="keyword">end</span>
<span class="function"><span class="keyword">end</span></span>
</pre></td></tr></table></figure>

<p>在 new action 里创建一个新的实例化变量叫做 @post。</p>
<p>在 create action 下，当 save 返回 false 时，我们使用了 render 而不是 redirect_to。render 方法使得 @post 对象被传递回 new 模版。</p>
<p>如果现在重新载入<a href="http://localhost:3000/posts/new">http://localhost:3000/posts/new</a>，不添加题目就进行表单提交，Rails 会重新将你带回表单页面。我们需要在这里添加错误提示信息。进入 app/views/posts/new.html.erb, 在表单信息前添加代码</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre> <span class="vbscript">&lt;% <span class="keyword">if</span> @post.errors.any? %&gt;</span>
2<span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"error_explanation"</span>&gt;</span>
22<span class="tag">&lt;<span class="title">h2</span>&gt;</span><span class="vbscript">&lt;%= pluralize(@post.errors.count, <span class="string">"error"</span>) %&gt;</span> prohibited
222this post from being saved:
22<span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
22<span class="tag">&lt;<span class="title">ul</span>&gt;</span>
22<span class="vbscript">&lt;% @post.errors.full_messages.<span class="keyword">each</span> <span class="keyword">do</span> |msg| %&gt;</span>
222<span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="vbscript">&lt;%= msg %&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span>
22<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
22<span class="tag">&lt;/<span class="title">ul</span>&gt;</span>
2<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
 <span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
</pre></td></tr></table></figure>

<p>我们首先通过 @post.errors.any? 检查对象中是否存在错误。然后在通过 @post.errors.full_messages 将错误信息呈现在页面内。</p>
<p>pluralize 是一个 rails 自带工具方法，一个数字和一个字符串作为参数，当数字大于 1，字符串会自动显示为复数形式。</p>
<p>这里就可以解释为什么我们在 new 方法中加上 @post = Post.new。由于显示错误信息的代码存在，如果不存在这个语句，@post 在视图中的值将会是 nil，@post.errors.any? 将会报错。</p>
<h4 id="updationg-posts">Updationg Posts</h4>
<p>如何更新 Posts。</p>
<p>首先在控制器中添加 edit 方法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="function"><span class="keyword">def</span> </span>edit
<span class="number">2</span><span class="variable">@post</span> = <span class="constant">Post</span>.find(params[<span class="symbol">:id</span>])
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>这个视图里的表单类似与创建 posts 页面。创建 app/views/posts/edit.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Editing Post<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
 <span class="vbscript">&lt;%= form_for :post, url: post_path(@post), method: :patch <span class="keyword">do</span> |f| %&gt;</span>
2
2<span class="vbscript">&lt;% <span class="keyword">if</span> @post.errors.any? %&gt;</span>
2<span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"error_explanation"</span>&gt;</span>
22<span class="tag">&lt;<span class="title">h2</span>&gt;</span><span class="vbscript">&lt;%= pluralize(@post.errors.count, <span class="string">"error"</span>) %&gt;</span> prohibited
222this post from being saved:
22<span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
22<span class="tag">&lt;<span class="title">ul</span>&gt;</span>
22<span class="vbscript">&lt;% @post.errors.full_messages.<span class="keyword">each</span> <span class="keyword">do</span> |msg| %&gt;</span>
222<span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="vbscript">&lt;%= msg %&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span>
22<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
22<span class="tag">&lt;/<span class="title">ul</span>&gt;</span>
2<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
2<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :title %&gt;</span><span class="tag">&lt;<span class="title">br</span>&gt;</span>
22<span class="vbscript">&lt;%= f.text_field :title %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :text %&gt;</span><span class="tag">&lt;<span class="title">br</span>&gt;</span>
22<span class="vbscript">&lt;%= f.text_area :text %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.submit %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>

<span class="vbscript">&lt;%= link_to <span class="comment">'Back', posts_path %&gt;</span></span>
</pre></td></tr></table></figure>

<p>现在我们表单指向的是 update action, 我们会在之后进行定义。</p>
<p>这里的 method: :patch 选项，是告诉 Rails 我们希望这个表格通过 PATCH HTTP 方法进行提交。（Update resources according to the REST protocol）</p>
<p>接着我们在控制器中创建 update action</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="function"><span class="keyword">def</span> </span>update
<span class="number">2</span><span class="variable">@post</span> = <span class="constant">Post</span>.find(params[<span class="symbol">:id</span>])

<span class="number">2</span><span class="keyword">if</span> <span class="variable">@post</span>.update(params[<span class="symbol">:post</span>].permit(<span class="symbol">:title</span>, <span class="symbol">:text</span>))
<span class="number">22</span>redirect_to <span class="variable">@post</span>
<span class="number">2</span><span class="keyword">else</span>
<span class="number">22</span>render <span class="string">'edit'</span>
<span class="number">2</span><span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>当我们想要更新一个已经存在的记录的时候，使用方法 update。</p>
<p><em>注意</em>：update 方法并不必须每次更新全部字段，如果我们只要更新一个具体字段，只需要 @post.update(title: &#39;A new title&#39;), Rails 会仅更新 title 字段的值。</p>
<p>最后我们需要在每个 posts 后面添加一个链接，来进入 edit 和 show 页面。进入 app/views/posts/index.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">table</span>&gt;</span>
2<span class="tag">&lt;<span class="title">tr</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span>Title<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span>Text<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span><span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span><span class="tag">&lt;/<span class="title">th</span>&gt;</span>
2<span class="tag">&lt;/<span class="title">tr</span>&gt;</span>

2<span class="vbscript">&lt;% @posts.<span class="keyword">each</span> <span class="keyword">do</span> |post| %&gt;</span>
22<span class="tag">&lt;<span class="title">tr</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= post.title %&gt;</span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= post.text %&gt;</span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= link_to <span class="comment">'Show', post %&gt;</span></span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= link_to <span class="comment">'Edit', edit_post_path(post) %&gt;</span></span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
22<span class="tag">&lt;/<span class="title">tr</span>&gt;</span>
2<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
 <span class="tag">&lt;/<span class="title">table</span>&gt;</span>
</pre></td></tr></table></figure>

<p>同样，我们在 show 页面中也加入 edit 链接</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre>&lt;<span class="variable">%=</span> link_to <span class="string">'Back'</span>, posts_path <span class="variable">%&gt;</span>
| &lt;<span class="variable">%=</span> link_to <span class="string">'Edit'</span>, edit_post_path(<span class="variable">@post</span>) <span class="variable">%&gt;</span>
</pre></td></tr></table></figure>

<h4 id="using-partials-to-clean-up-duplication-in-views">Using partials to clean up duplication in views</h4>
<p>edit 页面和 show 页面共用了大量的代码，我们这里使用 view partial 将代码进行精简。Partial 文件以下划线开头。</p>
<p>创建新文件 app/views/posts/_form.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="vbscript">&lt;%= form_for @post <span class="keyword">do</span> |f| %&gt;</span>
2
2<span class="vbscript">&lt;% <span class="keyword">if</span> @post.errors.any? %&gt;</span>
2<span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"error_explanation"</span>&gt;</span>
22<span class="tag">&lt;<span class="title">h2</span>&gt;</span><span class="vbscript">&lt;%= pluralize(@post.errors.count, <span class="string">"error"</span>) %&gt;</span> prohibited
222this post from being saved:
22<span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
22<span class="tag">&lt;<span class="title">ul</span>&gt;</span>
22<span class="vbscript">&lt;% @post.errors.full_messages.<span class="keyword">each</span> <span class="keyword">do</span> |msg| %&gt;</span>
222<span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="vbscript">&lt;%= msg %&gt;</span><span class="tag">&lt;/<span class="title">li</span>&gt;</span>
22<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
22<span class="tag">&lt;/<span class="title">ul</span>&gt;</span>
2<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
2<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :title %&gt;</span><span class="tag">&lt;<span class="title">br</span>&gt;</span>
22<span class="vbscript">&lt;%= f.text_field :title %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :text %&gt;</span><span class="tag">&lt;<span class="title">br</span>&gt;</span>
22<span class="vbscript">&lt;%= f.text_area :text %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.submit %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
</pre></td></tr></table></figure>

<p>除去 from_for 内的定义，其余不变。form_for 如何定义正确的 action 和 method 值，会在后面提到。现在先更新 new 和 edit 模版。app/views/posts/new.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h1</span>&gt;</span>New Post<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
<span class="vbscript">&lt;%= render <span class="comment">'form' %&gt;</span></span>
<span class="vbscript">&lt;%= link_to <span class="comment">'Back', posts_path %&gt;</span></span>
</pre></td></tr></table></figure>

<p>app/views/posts/edit.html.ern</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Editing Post<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
<span class="vbscript">&lt;%= render <span class="comment">'form' %&gt;</span></span>
<span class="vbscript">&lt;%= link_to <span class="comment">'Back', posts_path %&gt;</span></span>
</pre></td></tr></table></figure>

<h4 id="deleting-posts">Deleting Posts</h4>
<p>加入 CRUD 中的 D 部分。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="constant">DELETE</span>     /posts/<span class="symbol">:id</span>(.<span class="symbol">:format</span>)      posts<span class="comment">#destroy</span>
</pre></td></tr></table></figure>

<p>将 DELETE 方法写入控制器中</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="function"><span class="keyword">def</span> </span>destroy
<span class="number">2</span><span class="variable">@post</span> = <span class="constant">Post</span>.find(params[<span class="symbol">:id</span>])
<span class="number">2</span><span class="variable">@post</span>.destroy

<span class="number">2</span>redirect_to posts_path
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>通过 AR 的 destroy 方法完成从数据库的数据删除，然后直接将页面导向 index。</p>
<p>最后在 index 页面加上 destroy 链接 app/views/posts/index.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">table</span>&gt;</span>
2<span class="tag">&lt;<span class="title">tr</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span>Title<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span>Text<span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span><span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span><span class="tag">&lt;/<span class="title">th</span>&gt;</span>
22<span class="tag">&lt;<span class="title">th</span>&gt;</span><span class="tag">&lt;/<span class="title">th</span>&gt;</span>
2<span class="tag">&lt;/<span class="title">tr</span>&gt;</span>

2<span class="vbscript">&lt;% @posts.<span class="keyword">each</span> <span class="keyword">do</span> |post| %&gt;</span>
22<span class="tag">&lt;<span class="title">tr</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= post.title %&gt;</span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= post.text %&gt;</span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= link_to <span class="comment">'Show', post %&gt;</span></span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= link_to <span class="comment">'Edit', edit_post_path(post) %&gt;</span></span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
222<span class="tag">&lt;<span class="title">td</span>&gt;</span><span class="vbscript">&lt;%= link_to <span class="comment">'Destroy', post_path(post),</span>
<span class="number">22222222</span>method: :delete, data: {confirm: <span class="comment">'Are you sure?' } %&gt;</span></span><span class="tag">&lt;/<span class="title">td</span>&gt;</span>
22<span class="tag">&lt;/<span class="title">tr</span>&gt;</span>
2<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
<span class="tag">&lt;/<span class="title">table</span>&gt;</span>
</pre></td></tr></table></figure>

<p>这里用了不同的方式使用了 link_to。其中利用了 HTML5 的参数:method,:data-confirm。Rails 首先会弹出确认对话框，当点击确认后，会执行 delete 方法，这个是通过 jquery_ujs 实现的。这部分代码被包含在 app/views/layouts/application.html.erb 中。</p>
<p>有关路径的话题，之后还会详细的进行阐述。</p>
<h2 id="adding-a-second-model">Adding a Second Model</h2>
<hr>
<p>现在是时候添加第二个 model，第二个 model 用来处理 post 下的评论。</p>
<h4 id="generating-a-model">Generating a model</h4>
<p>这里我们要开始创建一个新的 model Comment。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="tag">rails</span> <span class="tag">generate</span> <span class="tag">model</span> <span class="tag">Comment</span> <span class="tag">commenter</span><span class="pseudo">:string</span> <span class="tag">body</span><span class="pseudo">:text</span> <span class="tag">post</span><span class="pseudo">:references</span>
</pre></td></tr></table></figure>

<p>这个命令将会生成四个文件。</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>db/migrate/xxxxx_create_comments.rb</td>
<td>Migration to create the comments table in your database</td>
</tr>
<tr>
<td>app/models/comment.rb</td>
<td>The comment model</td>
</tr>
<tr>
<td>test/models/comment_test.rb</td>
<td>针对 comments model 进行测试的文件</td>
</tr>
<tr>
<td>test/fixtures/comments.yml</td>
<td>Sample comments for use in testing</td>
</tr>
</tbody>
</table>
<p>首先，看一下 app/models/comment.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span>
  belongs_to <span class="symbol">:post</span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>这与 post.rb 非常相似，只是多了一句 belong_to :post，用来建立一个 AR association.</p>
<p>我们再来看下建立数据库表格的文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">CreateComments</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Migration</span></span></span>
  <span class="function"><span class="keyword">def</span> </span>change
    create_table <span class="symbol">:comments</span> <span class="keyword">do</span> |t|
      t.string <span class="symbol">:commenter</span>
      t.text <span class="symbol">:body</span>
      t.references <span class="symbol">:post</span>

      t.timestamps
    <span class="keyword">end</span>

    add_index <span class="symbol">:comments</span>, <span class="symbol">:post_id</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>t.references 行在两个 model 之间建立了一个外键，add_index 在相关的字段之间建立起了索引。执行命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>rake db:migrate
(in /Users/maleighton/rails_projects/blog)
=<span class="ruby">=  <span class="constant">CreateComments</span><span class="symbol">:</span> migrating =================================================
</span>-<span class="ruby">- create_table(<span class="symbol">:comments</span>)
</span>   -<span class="ruby">&gt; <span class="number">0</span>.<span class="number">0056</span>s
</span>-<span class="ruby">- add_index(<span class="symbol">:comments</span>, <span class="symbol">:post_id</span>)
</span>   -<span class="ruby">&gt; <span class="number">0</span>.<span class="number">0004</span>s
</span>=<span class="ruby">=  <span class="constant">CreateComments</span><span class="symbol">:</span> migrated (<span class="number">0</span>.<span class="number">0061</span>s) ========================================</span>
</pre></td></tr></table></figure>

<h4 id="associating-models">Associating Models</h4>
<p>AR associations 帮助我们在两个 model 之间建立起关系。在这个例子中，posts 和 comments 的关系是</p>
<ul>
<li>每个评论都归属于一个 post。</li>
<li>一个 post 可以由多个评论。 </li>
</ul>
<p>这就是在 model 文件中，belongs_to :post 起到的作用。
我们同时要将这个关系写入到 app/models/post.rb 中，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span>
<span class="number">2</span>has_many <span class="symbol">:comments</span>
<span class="number">2</span>validates <span class="symbol">:title</span>, <span class="symbol">presence:</span> <span class="keyword">true</span>,
<span class="number">2222</span>      <span class="symbol">length:</span> {<span class="symbol">minimum:</span> <span class="number">5</span>}
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>这两个定义都完成后，当我们有一个实例化变量 @post 的时候，就可以取出归属这个 post 下的所有 comment，@post.comments</p>
<h4 id="adding-a-route-for-comments">Adding a Route for Comments</h4>
<p>我们需要为 Comment 添加路径。进入 config/routes.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>resources <span class="symbol">:posts</span> <span class="keyword">do</span>
    resources <span class="symbol">:comments</span>
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>这里将 comments 作为 posts 的一个内部资源进行声明。显示出了两者之间的等级关系。</p>
<h4 id="generating-a-controller">Generating a Controller</h4>
<p>为 comment 建立控制器</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>rails <span class="keyword">generate</span> controller Comments
</pre></td></tr></table></figure>

<p>这里的业务逻辑是，读者在读完 post 之后，在 post 页面添加评论，当发送评论后，页面会回到 post show 页面，让读者立刻看到自己发表的评论。在控制器中需要添加 2 个方法，一个是新建 comments，另一个是删除 comments</p>
<p>首先我们进入 Post show 页面 app/views/posts/show.html.erb，来添加 comment 代码部分。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h2</span>&gt;</span>Add a comment:<span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
<span class="vbscript">&lt;%= form_for([@post, @post.comments.build]) <span class="keyword">do</span> |f| %&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :commenter %&gt;</span><span class="tag">&lt;<span class="title">br</span>/&gt;</span>
22<span class="vbscript">&lt;%= f.text_field :commenter %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :body %&gt;</span><span class="tag">&lt;<span class="title">br</span>/&gt;</span>
22<span class="vbscript">&lt;%= f.text_area :body %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.submit %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
</pre></td></tr></table></figure>

<p>这里添加在 post show 页面的表单，通过调用 CommentsController create action 来创建先的 comment。form_for 这里使用了一个数组，将会产生一个内嵌路径，posts/1/comments。</p>
<p>接着将 create 方法写入 app/controllers/comments_controller.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="function"><span class="keyword">def</span> </span>create
<span class="number">2</span><span class="variable">@post</span> = <span class="constant">Post</span>.find(params[<span class="symbol">:post_id</span>])
<span class="number">2</span><span class="variable">@comment</span> =<span class="variable">@post</span>.comments.create(params[<span class="symbol">:comment</span>].permit(<span class="symbol">:commenter</span>, <span class="symbol">:body</span>))
<span class="number">2</span>redirect_to post_path(<span class="variable">@post</span>)
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>在 showpage 中写入已存在 comment 的部分以及 view。进入 app/views/posts/show.html.erb.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h2</span>&gt;</span>Comments<span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
<span class="vbscript">&lt;% @post.comments.<span class="keyword">each</span> <span class="keyword">do</span> |comment| %&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="tag">&lt;<span class="title">strong</span>&gt;</span>Commenter:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span>
22<span class="vbscript">&lt;%= comment.commenter %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="tag">&lt;<span class="title">strong</span>&gt;</span>Comment:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span>
22<span class="vbscript">&lt;%= comment.body %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
</pre></td></tr></table></figure>

<h2 id="refactoring">Refactoring</h2>
<hr>
<p>完成了 posts 和 comments 的工作，可以看到 show 模版内的代码过于冗余了。这里对其进行优化。</p>
<h4 id="rendering-partial-collections">Rendering Partial Collections</h4>
<p>首先生成一个 comment partial 来提取展示评论的代码，新建 app/views/comments/_comment.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">strong</span>&gt;</span>Commenter:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span>
2<span class="vbscript">&lt;%= comment.commenter %&gt;</span>
 <span class="tag">&lt;/<span class="title">p</span>&gt;</span>

 <span class="tag">&lt;<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">strong</span>&gt;</span>Comment:<span class="tag">&lt;/<span class="title">strong</span>&gt;</span>
2<span class="vbscript">&lt;%= comment.body %&gt;</span>
 <span class="tag">&lt;/<span class="title">p</span>&gt;</span>
</pre></td></tr></table></figure>

<p>改变 app/views/posts/show.html.erb 内显示评论的部分。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h2</span>&gt;</span>Comments<span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
 <span class="vbscript">&lt;%= render @post.comments %&gt;</span>
</pre></td></tr></table></figure>

<p>render 方法可以遍历出 @post.comments。同时自动找到 partial，_comment.html.erb。</p>
<h4 id="rendering-a-partial-form">Rendering a Partial Form</h4>
<p>我们同时将新建评论区域抽离到 partial 内，新建 app/views/comments/_form.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="vbscript">&lt;%= form_for([@post, @post.comments.build]) <span class="keyword">do</span> |f| %&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :commenter %&gt;</span><span class="tag">&lt;<span class="title">br</span> /&gt;</span>
22<span class="vbscript">&lt;%= f.text_field :commenter %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.label :body %&gt;</span><span class="tag">&lt;<span class="title">br</span> /&gt;</span>
22<span class="vbscript">&lt;%= f.text_area :body %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
2<span class="tag">&lt;<span class="title">p</span>&gt;</span>
22<span class="vbscript">&lt;%= f.submit %&gt;</span>
2<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
<span class="vbscript">&lt;% <span class="keyword">end</span> %&gt;</span>
</pre></td></tr></table></figure>

<p>接着改写 app/views/posts/show.html</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
</pre></td><td class="code"><pre> <span class="tag">&lt;<span class="title">h2</span>&gt;</span>Add a comment:<span class="tag">&lt;/<span class="title">h2</span>&gt;</span>
<span class="vbscript">&lt;%= render <span class="string">"comments/form"</span> %&gt;</span>
</pre></td></tr></table></figure>

<p>由于我们定义了 @post 是一个实例化变量，so the @post object is available to any partials rendered in the view.</p>
<h2 id="deleting-comments">Deleting Comments</h2>
<hr>
<p>添加删除评论的功能。需要在 CommentsController 内添加 DELETE action，同时在视图中添加一个删除链接。进入 app/views/comments/_comment.html.erb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre> &lt;p&gt;
<span class="number">2</span>&lt;%= link_to <span class="string">'Destroy Comment'</span>, [comment.<span class="built_in">post</span>, comment],
<span class="number">2222222</span>method: :<span class="built_in">delete</span>,
<span class="number">2222222</span>data: {confirm: <span class="string">'Are you sure?'</span>} %&gt;
&lt;/p&gt;
</pre></td></tr></table></figure>

<p>点击链接启动的 DELETE 链接是 /posts/:post_id/comments/:id, 于是我们进入 app/controllers/comments_controller.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="function"><span class="keyword">def</span> </span>destroy
<span class="number">2</span><span class="variable">@post</span> = <span class="constant">Post</span>.find(params[<span class="symbol">:post_id</span>])
<span class="number">2</span><span class="variable">@comment</span> = <span class="variable">@post</span>.comments.find(params[<span class="symbol">:id</span>])
<span class="number">2</span><span class="variable">@comment</span>.destroy
<span class="number">2</span>redirect_to post_path(<span class="variable">@post</span>)
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<p>先找到我们针对 post，然后定位 @post.comments 内的具体哪条评论，然后从数据库中删除，重新导向到 post show 页面。</p>
<h4 id="deleting-associated-objects">Deleting Associated Objects</h4>
<p>当我们删除到一条 post 后，所有与之相关的 comments 都会被删除。修改 app/models/post.rb, 添加 dependent 选项。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span>
<span class="number">2</span>has_many <span class="symbol">:comments</span>, <span class="symbol">dependent:</span> <span class="symbol">:destroy</span>
<span class="number">2</span>validates <span class="symbol">:title</span>, <span class="symbol">presence:</span> <span class="keyword">true</span>,
<span class="number">2222222222</span><span class="symbol">length:</span> {<span class="symbol">minimum:</span> <span class="number">5</span>}
<span class="keyword">end</span>
</pre></td></tr></table></figure>

<h2 id="security">Security</h2>
<p>Rails 自带了一个简单的 HTTP 权限系统。如果非经验证的用户将会被阻止使用 actions。http_basic_authenticate_with 方法。为了使用这个方法，我们将其定义在 PostsController 顶部。在这里除去 index 和 show，其他所有的 action 若非获得权限禁止使用。重写 app/controllers/posts_controller.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>http_basic_authenticate_with <span class="symbol">name:</span> <span class="string">"Leighton"</span>, <span class="symbol">password:</span> <span class="string">"123456"</span>, <span class="symbol">except:</span> [<span class="symbol">:index</span>, <span class="symbol">:show</span>]
</pre></td></tr></table></figure>

<p>在 CommentsController 中禁止未获权限的用户进行评论删除，重写 app/controllers/comments_controller.rb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>http_basic_authenticate_with <span class="symbol">name:</span> <span class="string">"Leighton"</span>, <span class="symbol">password:</span> <span class="string">"123456"</span>, <span class="symbol">only:</span> <span class="symbol">:destroy</span>
</pre></td></tr></table></figure>

<h2 id="eof">EOF</h2>
<p>[^1]: Rack provides a minimal interface between webservers supporting Ruby and Ruby frameworks.<a href="http://rack.github.io/">Rack: a Ruby Webserver Interface</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://leightonma.github.io/2014/02/02/2014-02-02-getting-started-with-rails/" data-id="bnfui2ibmhibz53r" class="article-share-link">Share</a>
      
        <a href="http://leightonma.github.io/2014/02/02/2014-02-02-getting-started-with-rails/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/02/07/jian-bu-duan-,li-huan-luan/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          剪不断，理还乱
        
      </div>
    </a>
  
  
    <a href="/2014/01/19/2014-01-19-wu-ti-1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Endless Love</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ego/">Ego</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ego/">Ego</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RailsGuides/">RailsGuides</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ego/">Ego</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RailsGuides/">RailsGuides</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ego/">ego</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02">二月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01">一月 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/02/07/jian-bu-duan-,li-huan-luan/">剪不断，理还乱</a>
          </li>
        
          <li>
            <a href="/2014/02/02/2014-02-02-getting-started-with-rails/">Getting Started with Rails</a>
          </li>
        
          <li>
            <a href="/2014/01/19/2014-01-19-wu-ti-1/">Endless Love</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 Leighton Ma<br>
      Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">AboutMe</a>
  
</nav>
    
<script>
  var disqus_shortname = 'karmaposplace';
  
  var disqus_url = 'http://leightonma.github.io/2014/02/02/2014-02-02-getting-started-with-rails/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script type="text/javascript" src="/js/script.js"></script>
  </div>
</body>
</html>